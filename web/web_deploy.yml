AWSTemplateFormatVersion: '2010-09-09'
Description: "Cloudformation Deployment for website side of the document_aggregator"

Resources:
  AggregatorWebPageDeadLetterQueue:
    Type: "AWS::SQS::Queue"
    Properties:
      QueueName: "AggregatorWebPageDeadLetterQueue"
  GetTopics: 
    Type: "AWS::Lambda::Function"
    Properties: 
      Code: 
        ZipFile: ""
      Description: "Get the topics currently in DynamoDB"
      FunctionName: GetTopics
      Handler: index.lambda_handler
      Layers: 
        - "arn:aws:lambda:us-east-1:353290830413:layer:boto3:38"
      MemorySize: 128
      Role: "arn:aws:iam::353290830413:role/lambda_test_role"
      Runtime: python3.6
      Timeout: 600
      DeadLetterConfig:
        TargetArn:
          Fn::GetAtt: [ AggregatorWebPageDeadLetterQueue, Arn ]
  AggregatorRestApiIamRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ''
            Effect: 'Allow'
            Principal:
              Service:
                - 'apigateway.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      Path: '/'
      Policies:
        - PolicyName: 'ApiLambdaAccess'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action: 'lambda:*'
                Resource:
                  Fn::GetAtt: [ GetTopics, Arn ]
        - PolicyName: 'ApiLogging'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: 'arn:aws:logs:*:*:*'
  AggregatorRestApi:
    Type: "AWS::ApiGateway::RestApi"
    Properties:
      Name: "aggregator-api"
      Description: "A public API for accessing the web aggregator lambda functions for use in a serverless website"
  AggregatorTopicsResource:
    Type: "AWS::ApiGateway::Resource"
    Properties:
      ParentId:
        Fn::GetAtt: [ AggregatorRestApi, RootResourceId ]
      PathPart: 'topics'
      RestApiId: 
        Ref: AggregatorRestApi
  AggregatorTopicsMethod:
    Type: "AWS::ApiGateway::Method"  
    Properties:
      ApiKeyRequired: false
      AuthorizationType: NONE #Temporary test value; update to use COGNITO_USER_POOLS later
      HttpMethod: GET
      Integration:
        ConnectionType: INTERNET
        IntegrationHttpMethod: GET
        Credentials:
          Fn::GetAtt: [ AggregatorRestApiIamRole, Arn ]
        PassthroughBehavior: WHEN_NO_MATCH
        Type: AWS_PROXY
        Uri: 
          Fn::Sub: 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetTopics.Arn}/invocations'
      ResourceId:
        Ref: AggregatorTopicsResource
      RestApiId:
        Ref: AggregatorRestApi
  AggregatorTopicsModel:
    Type: "AWS::ApiGateway::Model"
    Properties:
      ContentType: 'application/json'
      RestApiId: 
        Ref: AggregatorRestApi
      Schema: {}
  AggregatorDevStage:
    Type: "AWS::ApiGateway::Stage"
    Properties:
      DeploymentId: 
        Ref: AggregatorDevDeployment
      Description: "Development stage for aggregator web api"
      RestApiId: 
        Ref: AggregatorRestApi
      StageName: 'dev'
  AggregatorDevDeployment:
    Type: "AWS::ApiGateway::Deployment"
    DependsOn: AggregatorTopicsMethod
    Properties:
      Description: "Deployment of develepment state for aggregator web api"
      RestApiId: 
        Ref: AggregatorRestApi